<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>読解問題ビューア（JSON貼り付け）</title>
  <style>
    :root{
      --bg:#f4fbff;
      --card:#ffffff;
      --text:#16384b;
      --muted:#5b7787;
      --accent:#2aa0df;
      --ok:#1f9d66;
      --warn:#e46a5c;
      --shadow:0 10px 24px rgba(0,0,0,.10);
      --radius:18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Yu Gothic", "Noto Sans JP", sans-serif;
      background: linear-gradient(180deg, #eef9ff 0%, #f7fff7 100%);
      color:var(--text);
      min-height:100dvh;
    }
    header{
      position:sticky; top:0; z-index:5;
      background: rgba(244,251,255,.86);
      backdrop-filter: blur(8px);
      border-bottom:1px solid rgba(0,0,0,.06);
    }
    .wrap{ width:min(980px, 100%); margin:0 auto; padding:14px 14px 22px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .btn{
      appearance:none; border:none; cursor:pointer;
      padding:12px 14px; border-radius:14px;
      background:var(--accent); color:white; font-weight:800;
      box-shadow: 0 10px 18px rgba(42,160,223,.22);
      display:inline-flex; align-items:center; gap:10px;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.secondary{
      background:#ffffff; color:var(--text);
      border:1px solid rgba(0,0,0,.10);
      box-shadow: none;
    }
    .btn.ok{ background:var(--ok); }
    .btn.warn{ background:var(--warn); }

    .card{
      background:var(--card);
      border:1px solid rgba(0,0,0,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      margin-top: 12px;
    }
    .title{
      font-size: 22px;
      font-weight: 900;
      margin: 0 0 6px;
      letter-spacing: .02em;
    }
    .scenario{
      margin: 0;
      color:var(--muted);
      line-height:1.55;
      font-weight:600;
    }

    textarea{
      width:100%;
      min-height: 180px;
      resize: vertical;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Noto Sans Mono", monospace;
      font-size: 13px;
      line-height: 1.45;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.14);
      outline: none;
      background: #fbfdff;
      color: #0b2a3a;
    }
    .hint{
      margin: 8px 0 0;
      color:var(--muted);
      font-size: 13px;
      line-height:1.45;
      font-weight:600;
    }

    table{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      overflow:hidden;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.10);
      background:#fff;
    }
    th, td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(0,0,0,.08);
      vertical-align: top;
      font-size: 15px;
    }
    th{
      text-align:left;
      background: #f2f8ff;
      font-weight: 900;
    }
    tr:last-child td{ border-bottom:none; }
    .col-time{ width: 90px; white-space: nowrap; font-weight: 900; }

    .qblock{ margin-top: 12px; }
    .qtitle{
      font-weight: 900;
      margin: 0 0 6px;
      font-size: 16px;
    }
    .qtext{
      margin: 0 0 8px;
      line-height: 1.55;
      font-weight: 650;
    }
    .choices{
      display:grid;
      grid-template-columns: repeat(1, 1fr);
      gap: 8px;
    }
    .choice{
      border: 1px solid rgba(0,0,0,.10);
      background:#fff;
      border-radius: 14px;
      padding: 10px;
      display:flex;
      gap: 10px;
      align-items:flex-start;
    }
    .badge{
      width: 34px; height: 34px;
      border-radius: 12px;
      display:grid; place-items:center;
      background:#e9f6ff;
      color:#0b4c6d;
      font-weight: 1000;
      flex: 0 0 auto;
      border: 1px solid rgba(0,0,0,.08);
    }
    .choice-main{ flex:1; }
    .choice-line{
      margin:0;
      font-weight: 750;
      line-height:1.45;
    }
    .clockbox{
      margin-top: 8px;
      border-radius: 14px;
      border: 1px dashed rgba(0,0,0,.22);
      padding: 10px;
      background: #fbfdff;
    }
    .clockbox .small{ color:var(--muted); font-size: 12px; font-weight:700; margin: 6px 0 0; }
    .clock-row{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }
    .clock-choice{
      border: 1px solid rgba(0,0,0,.10);
      border-radius: 14px;
      padding: 10px;
      background:#fff;
      display:flex;
      gap: 10px;
      align-items:center;
    }
    .clock-label{
      width: 34px; height: 34px;
      border-radius: 12px;
      display:grid; place-items:center;
      background:#e9f6ff;
      color:#0b4c6d;
      font-weight: 1000;
      border: 1px solid rgba(0,0,0,.08);
      flex:0 0 auto;
    }
    .clock-time{
      font-weight: 950;
      letter-spacing: .02em;
      white-space: nowrap;
    }
    .imgph{
      margin-left:auto;
      width: 112px;
      height: 72px;
      border-radius: 12px;
      background: repeating-linear-gradient(
        45deg,
        #f4f7fb,
        #f4f7fb 10px,
        #eef3f8 10px,
        #eef3f8 20px
      );
      border: 1px solid rgba(0,0,0,.10);
      display:grid;
      place-items:center;
      color: var(--muted);
      font-size: 12px;
      font-weight: 800;
      padding: 6px;
      text-align:center;
    }

    details{
      margin-top: 10px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.10);
      background:#fff;
      padding: 10px 12px;
    }
    summary{
      cursor:pointer;
      font-weight: 950;
      color:#0b4c6d;
    }
    .ans{
      margin: 10px 0 0;
      padding: 10px;
      border-radius: 14px;
      background: #f2fff7;
      border: 1px solid rgba(31,157,102,.25);
    }
    .ans p{ margin: 6px 0; font-weight: 700; line-height: 1.55; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Noto Sans Mono", monospace; }
    .err{
      color:#7b1f14;
      background:#fff3f1;
      border:1px solid rgba(228,106,92,.30);
      border-radius: 14px;
      padding: 10px;
      font-weight: 800;
      line-height:1.45;
      margin-top: 10px;
      white-space: pre-wrap;
    }

    @media (min-width: 720px){
      .choices{ grid-template-columns: repeat(2, 1fr); }
    }

    @media print{
      header{ position: static; border:none; background:transparent; }
      body{ background:#fff; }
      .btn, .hint, textarea, .card#inputCard { display:none !important; }
      .card{ box-shadow:none; }
      .imgph{ border:1px solid #aaa; }
      details{ border:1px solid #aaa; }
    }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row">
      <button class="btn" id="openGptsBtn" type="button">GPTsを開く（問題生成）</button>
      <button class="btn secondary" id="loadSampleBtn" type="button">サンプルを入れる</button>
      <button class="btn ok" id="renderBtn" type="button">JSONを表示</button>
      <button class="btn warn" id="clearBtn" type="button">クリア</button>
    </div>
    <p class="hint">
      使い方：①「GPTsを開く」→生成されたJSONをコピー ②下の欄に貼る ③「JSONを表示」<br>
      ※問3の時計画像は、あなたが用意した画像をこのHTMLに組み込む想定（今はプレースホルダ表示）。
    </p>
  </div>
</header>

<main class="wrap">
  <section class="card" id="inputCard">
    <h2 class="title" style="margin-bottom:10px;">JSON貼り付け</h2>
    <textarea id="jsonInput" placeholder='{"version":"1.0", ... }'></textarea>
    <div id="errorBox" class="err" style="display:none;"></div>
  </section>

  <section class="card" id="outputCard" style="display:none;">
    <h1 class="title" id="outTitle"></h1>
    <p class="scenario" id="outScenario"></p>

    <div class="qblock">
      <h3 class="qtitle">スケジュール</h3>
      <div id="outTable"></div>
    </div>

    <div class="qblock" id="q1"></div>
    <div class="qblock" id="q2"></div>
    <div class="qblock" id="q3"></div>
    <div class="qblock" id="q4"></div>

    <details id="answerPanel">
      <summary>解答・解説（クリックで開く）</summary>
      <div class="ans" id="answers"></div>
    </details>
  </section>
</main>

<script>
(() => {
  "use strict";

  // ★ あなたのGPTsリンク（受け取り済み）
  const GPTS_URL = "https://chatgpt.com/g/g-6993202af6e48191b0317dc51e832337-da-wen-7";

  const $ = (id) => document.getElementById(id);

  const jsonInput = $("jsonInput");
  const errorBox = $("errorBox");
  const outputCard = $("outputCard");

  $("openGptsBtn").addEventListener("click", () => {
    window.open(GPTS_URL, "_blank", "noopener,noreferrer");
  });

  $("clearBtn").addEventListener("click", () => {
    jsonInput.value = "";
    hideError();
    outputCard.style.display = "none";
    window.scrollTo({ top: 0, behavior: "smooth" });
  });

  $("loadSampleBtn").addEventListener("click", () => {
    jsonInput.value = JSON.stringify(sampleData(), null, 2);
    hideError();
  });

  $("renderBtn").addEventListener("click", () => {
    hideError();
    const raw = jsonInput.value.trim();
    if (!raw) return showError("JSONが空です。GPTsの出力（{ から } まで）を貼り付けてください。");

    let data;
    try {
      data = JSON.parse(raw);
    } catch (e) {
      return showError("JSONの解析に失敗しました。\n\n" + String(e));
    }

    const err = validate(data);
    if (err) return showError(err);

    render(data);
    outputCard.style.display = "block";
    // 出力へスクロール
    outputCard.scrollIntoView({ behavior: "smooth", block: "start" });
  });

  function showError(msg){
    errorBox.style.display = "block";
    errorBox.textContent = msg;
  }
  function hideError(){
    errorBox.style.display = "none";
    errorBox.textContent = "";
  }

  // ========== バリデーション ==========
  function validate(d){
    // 最低限の必須キー
    const needRoot = ["version","seedHint","title","scenario","table","questions","explanations"];
    for (const k of needRoot){
      if (!(k in d)) return `必須キーがありません: ${k}`;
    }
    if (!Array.isArray(d.table) || d.table.length < 4 || d.table.length > 6){
      return "table は 4〜6行の配列である必要があります。";
    }
    for (let i=0;i<d.table.length;i++){
      const row = d.table[i];
      for (const k of ["time","activity","note"]){
        if (!(k in row)) return `table[${i}] に必須キーがありません: ${k}`;
      }
      if (!/^\d{1,2}:\d{2}$/.test(row.time)) return `table[${i}].time は H:MM 形式にしてください（例 9:05）。`;
    }
    if (!d.questions || typeof d.questions !== "object") return "questions が不正です。";
    const qs = ["q1","q2","q3","q4"];
    for (const q of qs){
      if (!(q in d.questions)) return `questions に必須キーがありません: ${q}`;
    }
    // q3
    const q3 = d.questions.q3;
    const needQ3 = ["type","prompt","clockTarget","clockChoices","clockAnswerIndex"];
    for (const k of needQ3){
      if (!(k in q3)) return `questions.q3 に必須キーがありません: ${k}`;
    }
    if (!Array.isArray(q3.clockChoices) || q3.clockChoices.length !== 4){
      return "questions.q3.clockChoices は 4つの配列にしてください。";
    }
    if (!(Number.isInteger(q3.clockAnswerIndex) && q3.clockAnswerIndex >= 0 && q3.clockAnswerIndex <= 3)){
      return "questions.q3.clockAnswerIndex は 0〜3 の整数にしてください。";
    }
    if (q3.clockChoices[q3.clockAnswerIndex] !== q3.clockTarget){
      return "questions.q3 の整合性エラー：clockChoices[clockAnswerIndex] が clockTarget と一致していません。";
    }
    // 時刻が重複してないか
    const set = new Set(q3.clockChoices);
    if (set.size !== 4) return "questions.q3.clockChoices の時刻が重複しています（4つすべて別にしてください）。";

    // q4
    const q4 = d.questions.q4;
    const needQ4 = ["type","prompt","choices","answerIndex"];
    for (const k of needQ4){
      if (!(k in q4)) return `questions.q4 に必須キーがありません: ${k}`;
    }
    if (!Array.isArray(q4.choices) || q4.choices.length !== 3){
      return "questions.q4.choices は 3つの配列にしてください。";
    }
    if (!(Number.isInteger(q4.answerIndex) && q4.answerIndex >= 0 && q4.answerIndex <= 2)){
      return "questions.q4.answerIndex は 0〜2 の整数にしてください。";
    }

    // ※『』ルール（軽いチェック：どこかに含まれていればOK）
    const notesAll = d.table.map(r => String(r.note || "")).join("\n");
    if (!notesAll.includes("『")) return "注意：表のnoteに『乗り物』が見当たりません（GPTsのルールでは必須）。";
    if (!notesAll.includes("※")) return "注意：表のnoteに※注釈が見当たりません（GPTsのルールでは必須）。";

    return "";
  }

  // ========== 描画 ==========
  function render(d){
    $("outTitle").textContent = d.title || "";
    $("outScenario").textContent = d.scenario || "";

    // table
    $("outTable").innerHTML = makeTable(d.table);

    // Q1
    $("q1").innerHTML = `
      <h3 class="qtitle">【問1】情報の抽出</h3>
      <p class="qtext">${escapeHtml(d.questions.q1.prompt)}</p>
    `;

    // Q2
    $("q2").innerHTML = `
      <h3 class="qtitle">【問2】時間の計算</h3>
      <p class="qtext">${escapeHtml(d.questions.q2.prompt)}</p>
    `;

    // Q3 (時計)
    const letters = ["ア","イ","ウ","エ"];
    const q3 = d.questions.q3;
    const clockChoicesHtml = q3.clockChoices.map((t, i) => `
      <div class="clock-choice">
        <div class="clock-label">${letters[i]}</div>
        <div class="clock-time mono">${escapeHtml(t)}</div>
        <div class="imgph">時計画像<br>（差し替え用）</div>
      </div>
    `).join("");

    $("q3").innerHTML = `
      <h3 class="qtitle">【問3】時計の読み</h3>
      <p class="qtext">${escapeHtml(q3.prompt)}</p>
      <div class="clockbox">
        <div class="clock-row">
          ${clockChoicesHtml}
        </div>
        <p class="small">
          ※ここは「あなたが用意する4つの時計画像（ア〜エ）」を配置する場所です。<br>
          今は時刻テキストのみ表示しています（clockChoices）。画像に置き換えたい場合は、このHTMLの該当部分に &lt;img&gt; を入れるだけでOKです。
        </p>
      </div>
    `;

    // Q4 (マナー3択)
    const q4 = d.questions.q4;
    $("q4").innerHTML = `
      <h3 class="qtitle">【問4】マナー・知識（3択）</h3>
      <p class="qtext">${escapeHtml(q4.prompt)}</p>
      <div class="choices">
        ${q4.choices.map((c, i) => `
          <div class="choice">
            <div class="badge">${i+1}</div>
            <div class="choice-main">
              <p class="choice-line">${escapeHtml(c)}</p>
            </div>
          </div>
        `).join("")}
      </div>
    `;

    // Answers
    const q1a = d.questions.q1.answer;
    const q2a = d.questions.q2.answer;
    const q3a = letters[q3.clockAnswerIndex];
    const q4a = String(q4.answerIndex + 1);

    $("answers").innerHTML = `
      <p>【問1】正解：<span class="mono">${escapeHtml(q1a)}</span><br>${escapeHtml(d.explanations.q1 || "")}</p>
      <p>【問2】正解：<span class="mono">${escapeHtml(q2a)}</span><br>${escapeHtml(d.explanations.q2 || "")}</p>
      <p>【問3】正解：<span class="mono">${q3a}</span>（<span class="mono">${escapeHtml(q3.clockTarget)}</span>）<br>${escapeHtml(d.explanations.q3 || "")}</p>
      <p>【問4】正解：<span class="mono">${q4a}</span><br>${escapeHtml(d.explanations.q4 || "")}</p>
    `;
  }

  function makeTable(rows){
    const head = `
      <table>
        <thead>
          <tr>
            <th class="col-time">時刻</th>
            <th>行く場所・すること</th>
            <th>交通手段や注意点</th>
          </tr>
        </thead>
        <tbody>
    `;
    const body = rows.map(r => `
      <tr>
        <td class="col-time mono">${escapeHtml(r.time)}</td>
        <td>${escapeHtml(r.activity)}</td>
        <td>${escapeHtml(r.note)}</td>
      </tr>
    `).join("");
    const tail = `</tbody></table>`;
    return head + body + tail;
  }

  function escapeHtml(s){
    s = String(s ?? "");
    return s
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  // ========== サンプル ==========
  function sampleData(){
    return {
      "version":"1.0",
      "seedHint":"sample",
      "title":"部活動の大会の日の予定",
      "scenario":"あなたは部活動の大会に出ます。時間と持ち物を確かめます。",
      "table":[
        {"time":"8:10","activity":"学校に集合","note":"※水とうを持つ"},
        {"time":"8:30","activity":"会場へ移動","note":"『電車』で行く"},
        {"time":"9:10","activity":"会場に到着・受付","note":"※うわぐつを出す"},
        {"time":"9:40","activity":"ウォーミングアップ","note":"走り回りすぎない"},
        {"time":"10:10","activity":"試合開始","note":"先生の話を聞く"}
      ],
      "questions":{
        "q1":{"type":"extract","prompt":"持っていくものを、表から1つ答えなさい。","answer":"水とう"},
        "q2":{"type":"time_calc","prompt":"8:30に出発して、9:10に到着しました。何分かかりましたか。","answer":"40分"},
        "q3":{"type":"clock_choice","prompt":"「試合開始」の時刻をさす時計はどれですか。ア〜エから1つ選びなさい。",
              "clockTarget":"10:10",
              "clockChoices":["10:10","10:01","9:10","10:40"],
              "clockAnswerIndex":0},
        "q4":{"type":"manners","prompt":"会場でのよい行動はどれですか。1つ選びなさい。",
              "choices":["走り回ってさわぐ","受付の人にあいさつする","他の人の道具を勝手に使う"],
              "answerIndex":1}
      },
      "explanations":{
        "q1":"表のnoteに「※水とう」とあります。",
        "q2":"9:10−8:30なので40分です。",
        "q3":"表の「試合開始」は10:10です。",
        "q4":"あいさつは相手に失礼がなく、気持ちよく行動できます。"
      }
    };
  }
})();
</script>
</body>
</html>
